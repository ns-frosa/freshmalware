from importlib.resources import path
from openpyxl import Workbook
from flask import Flask, redirect, url_for
from flask import send_file
from flask import render_template
import random
from fpdf import FPDF

app = Flask(__name__)

def createfreshmalware():
    workbook = Workbook()
    sheet = workbook.active

    num = random.randint(1,999999999)

    sheet["A1"] = "This is an automatically generated file, meant to be used in Netskope Demos to show the patient-0 alerting and policy functionality"
    sheet["A2"] = ""
    sheet['A3'] = "Keep in mind this file will only trigger Netskope engines and no other security tool will detect it"
    sheet['A4'] = 'URL: http://itrad3r.com/mine/Panel/PvqDq929BSx_A_D_M1n_a.php'
    sheet['A5'] = ""
    sheet['A6'] = 'The random number below is what makes the file unique and it matches the filename for easy verification'
    sheet['A7'] = num

    fname = "ns_freshmalware_" + str(num) + ".xlsx"
    fullpath = "./samples/" + fname

    workbook.save(filename=fullpath)

    return fname

def createfreshmalware_pdf(): 
    num = random.randint(1,999999999)
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("helvetica", size = 8)
    pdf.cell(txt = "This is an automatically generated file, meant to be used in Netskope Demos to show the patient-0 alerting and policy functionality.")
    pdf.ln(20)
    pdf.cell(txt = "Keep in mind this file will only trigger Netskope engines and no other security tool will detect it.")
    pdf.ln(20)
    pdf.cell(txt= "http://pepitos.tv/reparto/-elliot-gould")
    pdf.ln(20)
    pdf.cell(txt= "http://poc-files.threat-cloud.com/demo_orig/poc/small_subset/ed8c64360f2ca01c0f8acc27f4e03a0f3bc5ebb4_22.doc")
    pdf.ln(20)
    pdf.cell(txt= "The random number below is what makes the file unique and it matches the filename for easy verification")
    pdf.ln(20)
    pdf.cell(txt=f"uniqueness token: {num}")

    fname = "ns_freshmalware_" + str(num) + ".pdf"
    fullpath = "./samples/" + fname

    pdf.output(fullpath) 

    return fname


@app.route('/')
def index():
    return render_template("index.html")

@app.route('/get-known', methods=["GET"])
def download_known():
    return redirect('https://malware-samples-for-demos-neutralized.s3.amazonaws.com/7787ce23aa0b4eae8323a347472cf17a8377819cbc3df0772a045697a3d4149a.malware')

@app.route('/get-high-risk', methods=['GET'])
def download_highrisk():
    return redirect('https://ueba-demo-files.s3.amazonaws.com/netskope_poor_uci_index_test')

@app.route('/get-unknown', methods=['GET'])
def download_unknown():
    name = createfreshmalware()
    path = "./samples/" + name
    return send_file(path, as_attachment=True)

@app.route('/get-unknown-pdf', methods=['GET'])
def download_unknown_pdf():
    name = createfreshmalware_pdf()
    path = "./samples/" + name
    return send_file(path, as_attachment=True)

@app.route('/get')
def redir():
    return redirect(url_for('download_unknown'))




